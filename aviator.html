<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NamKyBet v1.40 Final</title>
    <style>
        :root {
            --bg: #0b0e11;
            --panel: #15191d;
            --accent: #e91e63;
            --gold: #ffd700;
            --green: #00e676;
            --text: #ffffff;
            --purple: #9c27b0;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', sans-serif; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        /* RGB ANIMATION (CH·∫¨M & SANG) */
        @keyframes rainbow-neon {
            0% { color: #ff3333; text-shadow: 0 0 10px #ff0000; }
            20% { color: #ffff33; text-shadow: 0 0 10px #ffff00; }
            40% { color: #33ff33; text-shadow: 0 0 10px #00ff00; }
            60% { color: #33ffff; text-shadow: 0 0 10px #00ffff; }
            80% { color: #3333ff; text-shadow: 0 0 10px #0000ff; }
            100% { color: #ff33ff; text-shadow: 0 0 10px #ff00ff; }
        }

        /* HEADER */
        .header {
            padding: 10px 15px; background: rgba(20, 20, 20, 0.95);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 10; height: 60px; flex-shrink: 0;
        }
        .brand-area { display: flex; flex-direction: column; justify-content: center; }
        .logo { 
            font-weight: 900; font-size: 1.1rem; letter-spacing: 1px; 
            text-transform: uppercase; line-height: 1.1;
            animation: rainbow-neon 8s linear infinite; /* T·ªëc ƒë·ªô ch·∫≠m 8s */
        }
        .sub-logo { font-size: 0.75rem; color: #888; font-weight: bold; font-style: italic; letter-spacing: 2px; }
        .right-area { display: flex; align-items: center; gap: 10px; }
        .balance { font-family: monospace; font-size: 1rem; color: var(--green); font-weight: bold; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; }
        .tnd-btn { background: #b71c1c; color: #fff; border: 1px solid #ff5252; font-weight: 900; font-size: 0.8rem; padding: 5px 8px; border-radius: 4px; cursor: pointer; }

        /* HISTORY */
        .history-bar { height: 34px; background: #000; display: flex; align-items: center; padding: 0 10px; overflow-x: auto; gap: 5px; border-bottom: 1px solid #333; flex-shrink: 0; }
        .hist-pill { padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; background: rgba(255,255,255,0.1); color: #aaa; white-space: nowrap; }
        .hist-pill.win { color: var(--green); border: 1px solid var(--green); background: rgba(0, 230, 118, 0.1); }
        .hist-pill.lose { color: var(--accent); border: 1px solid var(--accent); background: rgba(233, 30, 99, 0.1); }

        /* GAME AREA */
        .game-area { flex: 1; position: relative; overflow: hidden; background: radial-gradient(circle at center, #1f2630 0%, #0b0e11 100%); }
        canvas { display: block; width: 100%; height: 100%; }
        .center-info { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); text-align: center; pointer-events: none; width: 100%; }
        .multiplier { font-size: 4rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.5); line-height: 1; }
        .status-text { font-size: 1.1rem; font-weight: bold; margin-top: 5px; opacity: 0; text-transform: uppercase; letter-spacing: 2px; }
        .status-text.crash { color: var(--accent); opacity: 1; text-shadow: 0 0 10px red; }

        /* POPUPS */
        .win-popup { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%) scale(0); background: rgba(0, 230, 118, 0.95); padding: 10px 25px; border-radius: 50px; text-align: center; box-shadow: 0 0 30px var(--green); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; z-index: 20; }
        .win-popup.show { transform: translateX(-50%) scale(1); }
        .win-label { font-size: 0.7rem; letter-spacing: 1px; color:#003300; display:block; font-weight:bold;}
        .win-val { font-size: 1.5rem; font-weight:900; color:#003300; display:block;}

        .big-win-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s; }
        .big-win-title { font-size: 4rem; color: var(--gold); font-weight: 900; text-shadow: 0 0 20px var(--gold), 0 0 50px orange; animation: pulseBig 0.5s infinite alternate; margin: 0; }
        .big-win-amt { font-size: 3rem; color: #fff; font-weight: bold; margin-top: 10px; text-shadow: 0 2px 10px #000; }
        .big-win-sub { color: #aaa; margin-top: 5px; font-size: 1rem; background: #000; padding: 5px 15px; border-radius: 20px; }
        @keyframes pulseBig { from { transform: scale(1); } to { transform: scale(1.1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CONTROLS */
        .controls { padding: 15px; background: var(--panel); border-top: 1px solid #333; display: grid; grid-template-columns: 140px 1fr; gap: 10px; flex-shrink: 0; }
        .bet-col { display: flex; flex-direction: column; gap: 5px; }
        input[type=number] { width: 100%; background: #0b0e11; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 6px; font-size: 1.1rem; text-align: center; font-weight: bold; }
        .quick-bets-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 3px; }
        .q-btn { background: #2c3e50; border: none; color: #ccc; border-radius: 4px; padding: 8px 0; cursor: pointer; font-weight: bold; font-size: 0.7rem; }
        .q-btn.neg { background: #3e2723; color: #ffab91; }
        .q-btn:active { transform: scale(0.95); }

        .main-btn { width: 100%; height: 100%; border: none; border-radius: 8px; font-size: 1.4rem; font-weight: 900; text-transform: uppercase; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s; display: flex; justify-content: center; align-items: center; }
        .main-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        
        .btn-green { background: var(--green); color: #003300; }
        .btn-orange { background: var(--accent); color: #fff; animation: pulse 1s infinite; }
        .btn-grey { background: #333; color: #777; cursor: not-allowed; }
        .btn-purple { background: var(--purple); color: #fff; animation: glowFast 0.5s infinite alternate; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(233, 30, 99, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(233, 30, 99, 0); } }
        @keyframes glowFast { from { box-shadow: 0 0 10px var(--purple); } to { box-shadow: 0 0 25px var(--purple); } }

        /* ADMIN */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 2px solid var(--accent); width: 85%; max-width: 300px; padding: 20px; border-radius: 15px; text-align: center; }
        .adm-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: var(--gold); font-size: 1.1rem; text-align: center; }
        .adm-btn { background: var(--accent); color: #fff; width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        .version-tag { position: fixed; bottom: 5px; right: 10px; font-size: 0.7rem; color: rgba(255,255,255,0.2); z-index: 50; pointer-events: none; font-family: monospace; }
        #bg-canvas, #fx-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 90; }
        #fx-canvas { z-index: 1000; }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand-area">
            <div class="logo">NamKyBet.Vip59Y2</div>
            <div class="sub-logo">Aviator</div>
        </div>
        <div class="right-area">
            <div class="balance" id="bal-disp">100.00</div>
            <button class="tnd-btn" onclick="window.tndTrigger()">TND</button>
        </div>
    </div>

    <div class="history-bar" id="history"></div>

    <div class="game-area" id="game-area">
        <canvas id="gameCanvas"></canvas>
        <canvas id="fx-canvas"></canvas>
        <div class="center-info">
            <div class="multiplier" id="mult-disp">1.00x</div>
            <div class="status-text" id="status-text">FLEW AWAY!</div>
        </div>
        <div class="win-popup" id="win-popup">
            <span class="win-label">YOU CASHED OUT</span>
            <span class="win-val" id="win-val">0.00</span>
        </div>
    </div>

    <div class="big-win-overlay" id="bw-overlay" onclick="window.closeBigWin()">
        <div class="big-win-title">BIG WIN</div>
        <div class="big-win-amt" id="bw-amt">+0.00</div>
        <div class="big-win-sub">Ch·∫°m ƒë·ªÉ ƒë√≥ng (Ti·ªÅn ƒëang r∆°i!)</div>
    </div>

    <div class="version-tag">v1.40</div>

    <div class="controls">
        <div class="bet-col">
            <div class="input-group">
                <input type="number" id="bet-input" value="10">
            </div>
            <div class="quick-bets-grid">
                <button class="q-btn neg" onclick="window.addBet(-10)">-10</button>
                <button class="q-btn neg" onclick="window.addBet(-50)">-50</button>
                <button class="q-btn neg" onclick="window.addBet(-100)">-100</button>
                <button class="q-btn" onclick="window.addBet(10)">+10</button>
                <button class="q-btn" onclick="window.addBet(50)">+50</button>
                <button class="q-btn" onclick="window.addBet(100)">+100</button>
            </div>
        </div>
        <button class="main-btn btn-green" id="action-btn" onclick="window.handleBtn()">ƒê·∫∂T C∆Ø·ª¢C</button>
    </div>

    <div class="modal-overlay" id="admin-modal">
        <div class="modal-box">
            <h2 style="color:var(--gold); margin:0 0 15px 0;">ADMIN PANEL</h2>
            <div style="text-align:left; color:#888; font-size:0.8rem;">S·ªê D∆Ø:</div>
            <input type="number" class="adm-input" id="adm-bal">
            <div style="text-align:left; color:#888; font-size:0.8rem; margin-top:10px;">K·∫æT QU·∫¢ V√ÅN SAU (X):</div>
            <input type="number" class="adm-input" id="adm-res" placeholder="Tr·ªëng = Ng·∫´u nhi√™n">
            <button class="adm-btn" onclick="window.saveAdmin()">L∆ØU & ƒê√ìNG</button>
            <div style="margin-top:15px; color:#666; font-size:0.8rem; cursor:pointer;" onclick="window.closeAdmin()">ƒê√≥ng</div>
        </div>
    </div>

<script>
    // === CONFIG & VARIABLES ===
    const CFG = { minBet: 1, historyLen: 20 };
    let state = {
        bal: 100,
        bet: 10,
        hist: [],
        status: 'IDLE', 
        mult: 1.00,
        crashAt: 0,
        forced: null, 
        myCashAt: 0,
        gameTime: 0, 
        speedMode: 1
    };

    let actx, engineNode, engineOsc;
    let cvs, ctx, fxCvs, fxCtx, W, H;
    let particles = [], coins = [], bgX = 0;
    let lastFrameTime = 0;
    let coinInterval;

    // --- GLOBAL BINDING FUNCTIONS (FIX L·ªñI N√öT) ---
    window.addBet = function(v) {
        let val = parseInt(document.getElementById('bet-input').value) || 0;
        let newVal = val + v;
        if(newVal < 1) newVal = 1; 
        document.getElementById('bet-input').value = newVal;
    };

    window.handleBtn = function() {
        if(state.status === 'IDLE' || state.status === 'CRASHED') {
            startGame();
        } else if (state.status === 'RUNNING' || state.status === 'CASHED') {
            // N·∫øu ƒëang ch·∫°y -> Cashout
            // N·∫øu ƒë√£ Cashout r·ªìi -> Check xem c√≥ tua nhanh ƒë∆∞·ª£c kh√¥ng
            if(state.status === 'RUNNING') {
                cashOut();
            }
            
            // Logic Tua Nhanh (Ch·ªâ hi·ªán khi ƒë√£ Cashout v√† mult > 10x v√† ch∆∞a tua)
            if (state.status === 'CASHED' && state.mult > 10 && state.speedMode === 1) {
                state.speedMode = 5; // TƒÉng t·ªëc
                const btn = document.getElementById('action-btn');
                btn.textContent = "üöÄ ƒêANG TUA...";
                btn.className = "main-btn btn-purple";
                btn.disabled = true; // B·∫•m 1 l·∫ßn th√¥i
            }
        }
    };

    window.tndTrigger = function() {
        let pass = prompt("NH·∫¨P M·∫¨T KH·∫®U QU·∫¢N TR·ªä:");
        if(pass === '1836') window.openAdmin();
        else if (pass !== null) alert("Sai m·∫≠t kh·∫©u! C√∫t!");
    };

    window.openAdmin = function() { 
        document.getElementById('admin-modal').style.display = 'flex'; 
        document.getElementById('adm-bal').value = state.bal; 
    };
    window.closeAdmin = function() { document.getElementById('admin-modal').style.display = 'none'; };
    
    window.saveAdmin = function() {
        let b = parseFloat(document.getElementById('adm-bal').value);
        let r = parseFloat(document.getElementById('adm-res').value);
        if(!isNaN(b)) state.bal = b;
        if(!isNaN(r) && r >= 1) state.forced = r;
        updateUI(); save(); window.closeAdmin();
    };

    window.closeBigWin = function() {
        document.getElementById('bw-overlay').style.display = 'none';
        if(coinInterval) clearInterval(coinInterval);
        coins = [];
    };

    // --- GAME ENGINE ---
    window.onload = function() {
        cvs = document.getElementById('gameCanvas');
        ctx = cvs.getContext('2d');
        fxCvs = document.getElementById('fx-canvas');
        fxCtx = fxCvs.getContext('2d');
        
        resize();
        window.addEventListener('resize', resize);
        
        const saved = localStorage.getItem('namky_aviator_v140');
        if(saved) {
            const d = JSON.parse(saved);
            state.bal = d.bal;
            state.hist = d.hist;
            renderHist();
        }
        updateUI();
        requestAnimationFrame(loop);
    };

    function resize() {
        W = document.getElementById('game-area').offsetWidth;
        H = document.getElementById('game-area').offsetHeight;
        cvs.width = W; cvs.height = H;
        fxCvs.width = W; fxCvs.height = H;
    }

    function save() {
        localStorage.setItem('namky_aviator_v140', JSON.stringify({ bal: state.bal, hist: state.hist }));
    }

    function generateCrash() {
        if(state.forced) { let f = state.forced; state.forced = null; return f; }
        if(Math.random() < 0.005) return 1.00;
        const e = 2**32; const h = crypto.getRandomValues(new Uint32Array(1))[0];
        let r = Math.floor((100 * e - h) / (e - h)) / 100;
        if(r > 1.00 && r < 1.15) { if(Math.random() < 0.20) r = 1.20 + Math.random() * 0.3; }
        return Math.max(1.00, r);
    }

    function startGame() {
        let bet = parseFloat(document.getElementById('bet-input').value);
        if(bet > state.bal || bet <= 0) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");

        state.bal -= bet;
        state.bet = bet;
        state.crashAt = generateCrash();
        
        // Reset Time Vars
        state.gameTime = 0;
        state.speedMode = 1;
        lastFrameTime = Date.now();

        state.mult = 1.00;
        state.status = 'RUNNING';
        state.myCashAt = 0;
        
        updateUI();
        document.getElementById('win-popup').classList.remove('show');
        document.getElementById('status-text').style.opacity = 0;
        document.getElementById('mult-disp').style.color = '#fff';
        document.getElementById('bet-input').disabled = true;
        
        const btn = document.getElementById('action-btn');
        btn.textContent = "CASH OUT";
        btn.className = "main-btn btn-orange";
        btn.disabled = false;

        soundEngine(true);
    }

    function cashOut() {
        if(state.status !== 'RUNNING') return;
        state.status = 'CASHED'; 
        state.myCashAt = state.mult;
        const win = state.bet * state.myCashAt;
        state.bal += win;
        
        save();
        updateUI();

        const btn = document.getElementById('action-btn');
        btn.textContent = "ƒêANG BAY...";
        btn.className = "main-btn btn-grey";
        // Button is kept enabled for Fast Forward feature logic in handleBtn

        if(win > 2360) {
            triggerBigWin(win);
        } else {
            sfx('win');
            document.getElementById('win-val').textContent = win.toFixed(2);
            document.getElementById('win-popup').classList.add('show');
        }
    }

    function triggerBigWin(amt) {
        sfx('bigwin');
        const overlay = document.getElementById('bw-overlay');
        document.getElementById('bw-amt').textContent = "+" + amt.toLocaleString();
        overlay.style.display = 'flex';
        
        if(coinInterval) clearInterval(coinInterval);
        coinInterval = setInterval(() => {
            spawnCoinBatch();
            if(Math.random() < 0.3) fireworkSound(); 
        }, 200); // R∆°i d√†y ƒë·∫∑c h∆°n
    }

    function spawnCoinBatch() {
        for(let i=0; i<8; i++) {
            coins.push({
                x: Math.random() * W, y: -50,
                vy: 5 + Math.random() * 10,
                rot: Math.random() * Math.PI,
                vrot: (Math.random() - 0.5) * 0.2
            });
        }
    }

    function crash() {
        state.status = 'CRASHED';
        state.speedMode = 1; 
        soundEngine(false);
        sfx('crash');
        state.hist.unshift(state.crashAt);
        if(state.hist.length > CFG.historyLen) state.hist.pop();
        renderHist();
        save();

        document.getElementById('mult-disp').style.color = '#e91e63';
        const st = document.getElementById('status-text');
        st.textContent = `FLEW AWAY @ ${state.crashAt.toFixed(2)}x`;
        st.className = "status-text crash";
        
        const btn = document.getElementById('action-btn');
        btn.textContent = "ƒê·∫∂T C∆Ø·ª¢C";
        btn.className = "main-btn btn-green";
        btn.disabled = false;
        document.getElementById('bet-input').disabled = false;

        setTimeout(() => document.getElementById('win-popup').classList.remove('show'), 3000);
    }

    function updateUI() { document.getElementById('bal-disp').textContent = state.bal.toFixed(2); }
    function renderHist() {
        const d = document.getElementById('history'); d.innerHTML = '';
        state.hist.forEach(x => {
            const el = document.createElement('div');
            el.className = `hist-pill ${x >= 2 ? 'win' : 'lose'}`;
            el.textContent = x.toFixed(2)+'x';
            d.prepend(el);
        });
    }

    // === AUDIO ENGINE ===
    function initAudio() { if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)(); if(actx.state === 'suspended') actx.resume(); }
    function soundEngine(on) {
        initAudio();
        if(on) {
            if(engineNode) return;
            const osc = actx.createOscillator(); const gain = actx.createGain();
            osc.type = 'sawtooth'; osc.frequency.value = 100;
            const filter = actx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 400;
            osc.connect(filter); filter.connect(gain); gain.connect(actx.destination);
            gain.gain.setValueAtTime(0.1, actx.currentTime);
            osc.start();
            state.engineOsc = osc; state.engineGain = gain; engineNode = true;
        } else {
            if(state.engineOsc) {
                state.engineGain.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 0.5);
                state.engineOsc.stop(actx.currentTime + 0.5);
                state.engineOsc = null; engineNode = false;
            }
        }
    }
    function updatePitch(m) { if(state.engineOsc) state.engineOsc.frequency.setTargetAtTime(100 + (m * 30), actx.currentTime, 0.1); }
    
    function fireworkSound() {
        if(!actx) return;
        const t = actx.currentTime;
        const osc = actx.createOscillator();
        const gain = actx.createGain();
        osc.connect(gain); gain.connect(actx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(100, t);
        osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
        gain.gain.setValueAtTime(0.1, t);
        gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
        osc.start(t); osc.stop(t + 0.5);
    }

    function sfx(type) {
        initAudio(); const osc = actx.createOscillator(); const gain = actx.createGain(); osc.connect(gain); gain.connect(actx.destination);
        if(type === 'win') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(600, actx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, actx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.2, actx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 0.5);
            osc.start(); osc.stop(actx.currentTime + 0.5);
        } else if (type === 'crash') {
            const bufSize = actx.sampleRate * 0.5; const buf = actx.createBuffer(1, bufSize, actx.sampleRate); const data = buf.getChannelData(0); for(let i=0; i<bufSize; i++) data[i] = Math.random()*2 - 1;
            const noise = actx.createBufferSource(); noise.buffer = buf; noise.connect(gain); gain.connect(actx.destination);
            gain.gain.setValueAtTime(0.5, actx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 0.5); noise.start();
        } else if (type === 'bigwin') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(400, actx.currentTime);
            osc.frequency.linearRampToValueAtTime(800, actx.currentTime+0.2);
            gain.gain.setValueAtTime(0.3, actx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 1);
            osc.start(); osc.stop(actx.currentTime + 1);
        }
    }

    // === GAME LOOP ===
    function loop() {
        const now = Date.now();
        const dt = (now - lastFrameTime) / 1000;
        lastFrameTime = now;

        if(state.status === 'RUNNING' || state.status === 'CASHED') {
            state.gameTime += dt * state.speedMode; // Apply speed multiplier
            
            // e^(0.06 * t)
            state.mult = Math.exp(0.06 * state.gameTime);
            updatePitch(state.mult);

            // LOGIC TUA NHANH HI·ªÜN N√öT
            if(state.status === 'CASHED' && state.mult > 10 && state.speedMode === 1) {
                const btn = document.getElementById('action-btn');
                btn.className = "main-btn btn-purple";
                btn.textContent = "‚è© TUA NHANH";
                btn.disabled = false;
            }

            if(state.mult >= state.crashAt) { state.mult = state.crashAt; crash(); }
        }

        draw();
        drawFX();
        document.getElementById('mult-disp').textContent = state.mult.toFixed(2)+'x';
        requestAnimationFrame(loop);
    }

    function draw() {
        ctx.clearRect(0,0,W,H);
        if(state.status === 'RUNNING' || state.status === 'CASHED') { 
            bgX -= 2 * state.mult * (state.speedMode > 1 ? 0.3 : 1); 
            if(bgX <= -50) bgX = 0; 
        }
        ctx.strokeStyle = "rgba(233, 30, 99, 0.2)"; ctx.lineWidth = 1;
        for(let x=bgX; x<W; x+=50) { if(x<0) continue; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
        for(let y=0; y<H; y+=50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

        let px = 50, py = H - 50;
        if(state.status === 'RUNNING' || state.status === 'CASHED') {
            const progress = Math.min((state.mult - 1) / 4, 1);
            px = 50 + progress * (W * 0.7); py = (H - 50) - progress * (H * 0.6); py += Math.random() * 2;
            
            ctx.beginPath(); ctx.moveTo(0, H); ctx.quadraticCurveTo(px * 0.5, H, px, py + 10);
            ctx.strokeStyle = "#e91e63"; ctx.lineWidth = 4; ctx.shadowBlur = 20; ctx.shadowColor = "#ff4081"; ctx.stroke(); ctx.shadowBlur = 0;
            
            const grad = ctx.createLinearGradient(0, py, 0, H); grad.addColorStop(0, "rgba(233, 30, 99, 0.3)"); grad.addColorStop(1, "rgba(0,0,0,0)");
            ctx.fillStyle = grad; ctx.lineTo(px, H); ctx.lineTo(0, H); ctx.fill();

            let hue = (Date.now() / 10) % 360;
            // Particles spawn more if fast mode
            let spawnRate = state.speedMode > 1 ? 3 : 1;
            for(let k=0; k<spawnRate; k++) {
                particles.push({ x: px - 15, y: py + 5, vx: -Math.random()*5 - 2, vy: Math.random()*2 - 1, life: 1, color: `hsl(${hue}, 80%, 60%)` });
            }
        }

        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05 * state.speedMode;
            if(p.life <= 0) { particles.splice(i,1); continue; }
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.beginPath(); ctx.arc(p.x, p.y, 2+Math.random()*2, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
        }

        if(state.status !== 'CRASHED') drawJet(px, py);
        else { ctx.fillStyle = "orange"; ctx.beginPath(); ctx.arc(px, py, 40, 0, Math.PI*2); ctx.fill(); }
    }

    function drawFX() {
        fxCtx.clearRect(0,0,W,H);
        if(coins.length > 0) {
            coins.forEach(c => {
                c.y += c.vy; c.rot += c.vrot;
                if(c.y > H) c.y = -50;
                fxCtx.save(); fxCtx.translate(c.x, c.y); fxCtx.rotate(c.rot);
                fxCtx.beginPath(); fxCtx.arc(0,0, 15, 0, Math.PI*2); fxCtx.fillStyle = "gold"; fxCtx.fill();
                fxCtx.fillStyle = "#b8860b"; fxCtx.font = "bold 16px monospace"; fxCtx.fillText("$", -5, 5);
                fxCtx.restore();
            });
        }
    }

    function drawJet(x, y) {
        ctx.save(); ctx.translate(x, y); ctx.rotate(-15 * Math.PI / 180);
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.moveTo(25, 0); ctx.lineTo(-20, -8); ctx.lineTo(-20, 8); ctx.fill();
        ctx.fillStyle = "#aaa"; ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-30, 18); ctx.lineTo(-20, 0); ctx.fill();
        ctx.fillStyle = "#00e676"; ctx.beginPath(); ctx.ellipse(5, -4, 8, 3, 0, 0, Math.PI*2); ctx.fill();
        if(Date.now() % 200 < 100) { ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(0, 5, 2, 0, Math.PI*2); ctx.fill(); }
        ctx.restore();
    }
</script>
</body>
</html>
